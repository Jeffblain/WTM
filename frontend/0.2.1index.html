<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wine Tasting Selection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #8B0000, #A52A2A);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .toggle-view {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }
        
        .toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 10px;
            transition: all 0.3s;
        }
        
        .toggle-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .toggle-btn.active {
            background: #28a745;
        }
        
        .view {
            padding: 30px;
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .guest-names {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .guest-name-input {
            display: flex;
            flex-direction: column;
        }
        
        .guest-name-input label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #666;
        }
        
        .guest-name-input input {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .wine-grid {
            display: grid;
            grid-template-columns: 2fr repeat(4, 1fr);
            gap: 15px;
            margin-top: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .wine-header, .guest-header {
            font-weight: 700;
            color: #8B0000;
            padding: 15px 10px;
            background: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .wine-item {
            font-weight: 600;
            padding: 12px 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #8B0000;
        }
        
        .wine-name {
            font-size: 1rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        .wine-description {
            font-size: 0.8rem;
            color: #666;
            font-weight: 400;
            font-style: italic;
        }
        
        .wine-checkbox {
            text-align: center;
            padding: 10px;
        }
        
        .wine-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .group-tile {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .group-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .group-tile.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }
        
        .wine-glass {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .group-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        .group-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .order-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .guest-summary {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        
        .guest-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .guest-number {
            font-weight: 700;
            color: #333;
        }
        
        .guest-name-display {
            font-weight: 500;
            color: #007bff;
            font-size: 1.1rem;
        }
        
        .wine-service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .wine-service-item:last-child {
            border-bottom: none;
        }
        
        .wine-service-name {
            flex: 1;
            font-weight: 500;
        }
        
        .status-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .status-pending {
            background: #ffc107;
            color: #212529;
        }
        
        .status-servi {
            background: #28a745;
            color: white;
        }
        
        .status-non-servi {
            background: #8B0000;
            color: white;
        }
        
        .message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #545b62;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            z-index: 1000;
        }
        
        .connected {
            background: #28a745;
        }
        
        .disconnected {
            background: #dc3545;
        }
        
        .loading {
            background: #ffc107;
            color: #212529;
        }
        
        @media (max-width: 768px) {
            .wine-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .guest-header {
                display: none;
            }
            
            .wine-checkbox {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: white;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            
            .guest-names {
                grid-template-columns: 1fr;
            }
            
            .groups-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status loading">üîÑ Connecting...</div>
    
    <div class="container">
        <div class="header">
            <h1>üç∑ Vignoble le Chat Bott√© - D√©gustation</h1>
            <p>S√©lectionnez votre parfaite exp√©rience</p>
        </div>
        
        <div class="toggle-view">
            <button class="toggle-btn active" onclick="showView('visitor')">Formulaire pour invit√©s</button>
            <button class="toggle-btn" onclick="showView('host')">Tableau pour h√¥tes</button>
        </div>
        
        <!-- Visitor View -->
        <div id="visitor-view" class="view active">
            <div class="form-group">
                <label for="groupName">Nom du groupe (obligatoire)</label>
                <input type="text" id="groupName" placeholder="Entrez le nom de votre groupe..." required>
            </div>
            
            <div class="guest-names">
                <div class="guest-name-input">
                    <label>Invit√© 1 </label>
                    <input type="text" id="guest1Name" placeholder="Entrez votre pr√©nom...">
                </div>
                <div class="guest-name-input">
                    <label>Invit√© 2 </label>
                    <input type="text" id="guest2Name" placeholder="Entrez votre pr√©nom...">
                </div>
                <div class="guest-name-input">
                    <label>Invit√© 3 </label>
                    <input type="text" id="guest3Name" placeholder="Entrez votre pr√©nom...">
                </div>
                <div class="guest-name-input">
                    <label>Invit√© 4 </label>
                    <input type="text" id="guest4Name" placeholder="Entrez votre pr√©nom...">
                </div>
            </div>
            
            <div id="wineGrid" class="wine-grid">
                <!-- Wines will be loaded from backend -->
            </div>
            
            <div style="text-align: center;">
                <button class="submit-btn" id="submitOrder" onclick="submitOrder()">Soumettez votre s√©lection</button>
            </div>
            
            <div id="successMessage" style="display: none;">
                <div class="success-message">
                    <h3>‚úÖ Commande pass√©e avec succ√®s</h3>
                    <p>Votre s√©lection a √©t√© transmise, veuillez svp vous pr√©senter au comptoir de la boutique pour votre premi√®re d√©gustation</p>
                </div>
            </div>
        </div>
        
        <!-- Host View -->
        <div id="host-view" class="view">
            <div id="groupsView">
                <h2>S√©lectionnez un groupe</h2>
                <div class="groups-grid" id="groupsGrid">
                    <!-- Groups will be populated from backend -->
                </div>
            </div>
            
            <div id="groupDetailsView" style="display: none;">
                <button class="back-btn" onclick="showGroupsView()">‚Üê Retour aux groupes</button>
                <div id="hostContent">
                    <!-- Group details will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        // üîó BACKEND CONNECTION SETUP
        const API_BASE = 'http://localhost:3001';
        let socket;
        let wines = [];
        let currentGroup = null;
        
        // üöÄ Initialize connection and load wines
        document.addEventListener('DOMContentLoaded', async function() {
            // Clear all form data on page load for session isolation
            clearFormData();
            
            await connectToBackend();
            await loadWines();
            if (isHostView()) {
                await loadGroups();
            }
            
            // Set up dynamic guest name updates
            setupGuestNameListeners();
        });
        
        // üßπ Clear all form data for session isolation
        function clearFormData() {
            // Clear all input fields
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.value = '';
                input.disabled = false;
            });
            
            // Clear all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
            });
            
            // Reset submit button
            const submitBtn = document.getElementById('submitOrder');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Soumettez votre s√©lection';
            }
            
            // Hide success message
            const successMsg = document.getElementById('successMessage');
            if (successMsg) {
                successMsg.style.display = 'none';
            }
            
            console.log('üßπ Form cleared for new session');
        }
        
        // üéØ Setup guest name listeners for dynamic updates
        function setupGuestNameListeners() {
            for (let i = 1; i <= 4; i++) {
                const nameInput = document.getElementById(`guest${i}Name`);
                if (nameInput) {
                    nameInput.addEventListener('input', () => updateGuestLabels());
                    nameInput.addEventListener('blur', () => updateGuestLabels());
                }
            }
        }
        
        // üè∑Ô∏è Update guest labels and wine selection availability
        function updateGuestLabels() {
            for (let i = 1; i <= 4; i++) {
                const nameInput = document.getElementById(`guest${i}Name`);
                const name = nameInput ? nameInput.value.trim() : '';
                
                // Update all labels for this guest
                document.querySelectorAll(`.guest-label-${i}`).forEach(label => {
                    if (name) {
                        label.textContent = name;
                        label.style.color = '#007bff';
                        label.style.fontWeight = '600';
                    } else {
                        label.textContent = `Invit√© ${i}`;
                        label.style.color = '#666';
                        label.style.fontWeight = '400';
                    }
                });
                
                // Enable/disable wine selections based on guest name
                updateGuestWineSelections(i, name);
            }
        }
        
        // üç∑ Enable/disable wine selections for guest
        function updateGuestWineSelections(guestNum, guestName) {
            const hasName = guestName.length > 0;
            
            wines.forEach(wine => {
                const checkbox = document.getElementById(`wine${wine.id}-g${guestNum}`);
                const container = checkbox?.closest('.wine-checkbox');
                
                if (checkbox && container) {
                    checkbox.disabled = !hasName;
                    
                    if (hasName) {
                        container.style.opacity = '1';
                        container.style.cursor = 'pointer';
                        checkbox.style.cursor = 'pointer';
                    } else {
                        container.style.opacity = '0.4';
                        container.style.cursor = 'not-allowed';
                        checkbox.style.cursor = 'not-allowed';
                        checkbox.checked = false; // Clear selection when disabled
                    }
                }
            });
        }
        
        // üì° Connect to backend and Socket.io
        async function connectToBackend() {
            try {
                updateConnectionStatus('loading', 'üîÑ Connecting...');
                
                // Test backend connection
                const response = await fetch(`${API_BASE}/health`);
                if (!response.ok) throw new Error('Backend not available');
                
                // Initialize Socket.io
                socket = io(API_BASE);
                
                socket.on('connect', () => {
                    console.log('‚úÖ Connected to backend via Socket.io');
                    updateConnectionStatus('connected', 'üü¢ Connected');
                });
                
                socket.on('disconnect', () => {
                    console.log('‚ùå Disconnected from backend');
                    updateConnectionStatus('disconnected', 'üî¥ Disconnected');
                });
                
                // Listen for real-time order updates
                socket.on('orderUpdate', (data) => {
                    console.log('üì° Real-time order update:', data);
                    if (isHostView()) {
                        loadGroups(); // Refresh groups
                    }
                });
                
                updateConnectionStatus('connected', 'üü¢ Connected');
                
            } catch (error) {
                console.error('‚ùå Backend connection failed:', error);
                updateConnectionStatus('disconnected', 'üî¥ Backend Offline');
            }
        }
        
        // üç∑ Load wines from backend
        async function loadWines() {
            try {
                const response = await fetch(`${API_BASE}/api/wineries/1/wines`);
                if (!response.ok) throw new Error('Failed to load wines');
                
                wines = await response.json();
                console.log('üç∑ Loaded wines:', wines);
                renderWineGrid();
                
            } catch (error) {
                console.error('‚ùå Failed to load wines:', error);
                // Fallback to hardcoded wines if backend fails
                wines = [
                    { id: 1, name: "Ze Flying Pig - Cidre", description: "Cidre brut mousseux issu de nos pommes McIntosh..." },
                    { id: 2, name: "Petnat Chardonnay - Bulles", description: "P√©tillant naturel 100% Chardonnay..." },
                    { id: 3, name: "Blanc - Bio", description: "Vin √† la robe claire de reflets jaun√¢tres..." },
                    { id: 4, name: "Gris de Gris", description: "Ros√© pr√©sentant des notes typiques de pamplemousse..." },
                    { id: 5, name: "Ros√© Plamplemousse", description: "Robe de couleur p√™che, nez pr√©sentant des ar√¥mes frais..." },
                    { id: 6, name: "Premier Pas - Bio", description: "Vin rouge ferment√© en grappes enti√®res..." },
                    { id: 7, name: "H√©lium", description: "H√©lium tire son origine du mot grec Helios..." },
                    { id: 8, name: "Rouge Bourbon", description: "Premier vin rouge √©lev√© en f√ªts de Bourbon..." },
                    { id: 9, name: "Rouge Cognac", description: "Premier vin rouge √©lev√© en f√ªts de Cognac..." },
                    { id: 10, name: "Le Chat Noir", description: "Premier vin de paille fortifi√© au Qu√©bec..." }
                ];
                renderWineGrid();
            }
        }
        
        // üé® Render wine selection grid
        function renderWineGrid() {
            const grid = document.getElementById('wineGrid');
            let html = `
                <div class="wine-header">S√©lection de vins</div>
                <div class="guest-header"><span class="guest-label-1">Invit√© 1</span></div>
                <div class="guest-header"><span class="guest-label-2">Invit√© 2</span></div>
                <div class="guest-header"><span class="guest-label-3">Invit√© 3</span></div>
                <div class="guest-header"><span class="guest-label-4">Invit√© 4</span></div>
            `;
            
            wines.forEach((wine, index) => {
                html += `
                    <div class="wine-item">
                        <div class="wine-name">${wine.name}</div>
                        <div class="wine-description">${wine.description}</div>
                    </div>
                    <div class="wine-checkbox">
                        <input type="checkbox" id="wine${wine.id}-g1">
                        <span class="guest-label-1">Invit√© 1</span>
                    </div>
                    <div class="wine-checkbox">
                        <input type="checkbox" id="wine${wine.id}-g2">
                        <span class="guest-label-2">Invit√© 2</span>
                    </div>
                    <div class="wine-checkbox">
                        <input type="checkbox" id="wine${wine.id}-g3">
                        <span class="guest-label-3">Invit√© 3</span>
                    </div>
                    <div class="wine-checkbox">
                        <input type="checkbox" id="wine${wine.id}-g4">
                        <span class="guest-label-4">Invit√© 4</span>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            // Initialize guest labels and selections after rendering
            setTimeout(() => {
                updateGuestLabels();
            }, 100);
        }
        
        // üöÄ REAL BACKEND SUBMISSION - BULLETPROOF VERSION
        async function submitOrder() {
            const groupName = document.getElementById('groupName').value.trim();
            if (!groupName) {
                alert('Veuillez entrer un nom de groupe');
                return;
            }
            
            // BULLETPROOF: Check if already submitted
            const submitBtn = document.getElementById('submitOrder');
            if (submitBtn.disabled || submitBtn.textContent.includes('‚úÖ')) {
                console.log('üõë Order already submitted, ignoring duplicate request');
                return;
            }
            
            // Validate at least one guest has a name
            let hasActiveGuest = false;
            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`guest${i}Name`).value.trim();
                if (name) {
                    hasActiveGuest = true;
                    break;
                }
            }
            
            if (!hasActiveGuest) {
                alert('Veuillez entrer au moins un nom d\'invit√©');
                return;
            }
            
            // BULLETPROOF: Immediate form lock
            lockFormCompletely();
            submitBtn.textContent = 'üîÑ Envoi en cours...';
            
            try {
                // Collect guest names
                const guestNames = {};
                for (let i = 1; i <= 4; i++) {
                    const name = document.getElementById(`guest${i}Name`).value.trim();
                    if (name) guestNames[i] = name;
                }
                
                // Collect wine selections (only for guests with names)
                const selections = {};
                for (let guest = 1; guest <= 4; guest++) {
                    if (!guestNames[guest]) continue; // Skip guests without names
                    
                    selections[guest] = [];
                    wines.forEach(wine => {
                        const checkbox = document.getElementById(`wine${wine.id}-g${guest}`);
                        if (checkbox && checkbox.checked) {
                            selections[guest].push({
                                wineId: wine.id,
                                wineName: wine.name,
                                status: 'pending'
                            });
                        }
                    });
                }
                
                // Validate at least one wine selection
                let hasWineSelection = false;
                Object.values(selections).forEach(guestSelections => {
                    if (guestSelections.length > 0) hasWineSelection = true;
                });
                
                if (!hasWineSelection) {
                    alert('Veuillez s√©lectionner au moins un vin');
                    unlockForm(); // Allow retry
                    return;
                }
                
                // üì° REAL API CALL TO BACKEND
                const orderData = {
                    wineryId: 1,
                    groupName: groupName,
                    guestNames: guestNames,
                    selections: selections,
                    tableNumber: null,
                    notes: null
                };
                
                console.log('üì§ Submitting order to backend:', orderData);
                
                const response = await fetch(`${API_BASE}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    if (response.ok) {
                        result = { success: true, message: 'Order submitted successfully' };
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${result.error || response.statusText}`);
                }
                
                console.log('‚úÖ Order submitted successfully:', result);
                
                // PERMANENT SUCCESS STATE
                submitBtn.textContent = '‚úÖ Commande envoy√©e avec succ√®s!';
                submitBtn.style.background = '#28a745';
                
                // Show success message
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
                
                console.log('üîí Form permanently locked after successful submission');
                
            } catch (error) {
                console.error('‚ùå Order submission failed:', error);
                alert(`Erreur lors de l'envoi: ${error.message}\n\nV√©rifiez que le backend est d√©marr√© sur localhost:3001`);
                
                // Only unlock on actual error
                unlockForm();
            }
        }
        
        // üîí BULLETPROOF: Lock form completely
        function lockFormCompletely() {
            // Disable all inputs
            document.querySelectorAll('input').forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.6';
            });
            
            // Disable submit button
            const submitBtn = document.getElementById('submitOrder');
            submitBtn.disabled = true;
            
            console.log('üîí Form completely locked');
        }
        
        // üîì Unlock form (only for retry after error)
        function unlockForm() {
            // Re-enable inputs
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.disabled = false;
                input.style.opacity = '1';
            });
            
            // Re-enable submit button
            const submitBtn = document.getElementById('submitOrder');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Soumettez votre s√©lection';
            submitBtn.style.background = '';
            
            // Update guest selections based on names
            updateGuestLabels();
            
            console.log('üîì Form unlocked for retry');
        }
        
        // üìä Load groups for host dashboard
        async function loadGroups() {
            try {
                const response = await fetch(`${API_BASE}/api/orders`);
                if (!response.ok) throw new Error('Failed to load groups');
                
                const orders = await response.json();
                console.log('üìã Loaded orders:', orders);
                renderGroups(orders);
                
            } catch (error) {
                console.error('‚ùå Failed to load groups:', error);
                renderGroups([]); // Show empty state
            }
        }
        
        // üé® Render groups grid for host
        function renderGroups(orders) {
            const grid = document.getElementById('groupsGrid');
            
            if (orders.length === 0) {
                grid.innerHTML = `
                    <div class="message">
                        <h3>üç∑ Aucune commande pour le moment</h3>
                        <p>Les nouvelles commandes appara√Ætront ici automatiquement</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            orders.forEach(order => {
                const guestCount = Object.keys(order.guest_names || {}).length;
                const timestamp = new Date(order.created_at).toLocaleTimeString('fr-CA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="group-tile" onclick="selectGroup('${order.id}')">
                        <div class="wine-glass">üç∑</div>
                        <div class="group-name">${order.group_name}</div>
                        <div class="group-info">${guestCount} invit√©s ‚Ä¢ ${timestamp}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // üìã Select and display group details
        async function selectGroup(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/orders/${orderId}`);
                if (!response.ok) throw new Error('Failed to load order details');
                
                const order = await response.json();
                console.log('üìÑ Loaded order details:', order);
                displayGroupDetails(order);
                showGroupDetailsView();
                
            } catch (error) {
                console.error('‚ùå Failed to load order details:', error);
                alert('Erreur lors du chargement des d√©tails de la commande');
            }
        }
        
        // üé® Display group details for host with dynamic names
        function displayGroupDetails(order) {
            const content = document.getElementById('hostContent');
            const timestamp = new Date(order.created_at).toLocaleString('fr-CA');
            
            let html = `
                <div class="order-summary">
                    <h2>üç∑ Groupe: ${order.group_name}</h2>
                    <p><strong>Commande soumise:</strong> ${timestamp}</p>
                </div>
            `;
            
            // Parse selections from database
            const selections = typeof order.selections === 'string' ? 
                JSON.parse(order.selections) : order.selections;
            
            const guestNames = typeof order.guest_names === 'string' ? 
                JSON.parse(order.guest_names) : order.guest_names;
            
            for (let guest = 1; guest <= 4; guest++) {
                const guestSelections = selections[guest] || [];
                if (guestSelections.length > 0) {
                    const guestName = guestNames && guestNames[guest] ? 
                        guestNames[guest] : null;
                    
                    // Use guest name or fallback to "Invit√© X"
                    const displayName = guestName || `Invit√© ${guest}`;
                    const headerStyle = guestName ? 'style="color: #007bff; font-weight: 600;"' : '';
                    
                    html += `
                        <div class="guest-summary">
                            <div class="guest-title">
                                <span class="guest-number">${displayName}</span>
                                ${guestName ? `<span class="guest-name-display">üë§ ${guestName}</span>` : ''}
                            </div>
                    `;
                    
                    guestSelections.forEach((item, index) => {
                        const statusClass = getStatusClass(item.status);
                        const statusDisplay = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                        
                        html += `
                            <div class="wine-service-item">
                                <span class="wine-service-name">${item.wineName}</span>
                                <button class="${statusClass} status-btn" 
                                        onclick="updateWineStatus('${order.id}', ${guest}, ${index}, '${item.status}')"
                                        title="Cliquez pour changer le statut">
                                    ${statusDisplay}
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            }
            
            if (!html.includes('guest-summary')) {
                html += `
                    <div class="message">
                        <h3>ü§î Aucune s√©lection de vin trouv√©e</h3>
                        <p>Ce groupe n'a pas encore fait de s√©lections de vins.</p>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            currentGroup = order;
        }
        
        // üîÑ Update wine status (served/not served)
        async function updateWineStatus(orderId, guest, itemIndex, currentStatus) {
            const newStatus = currentStatus === 'pending' ? 'served' : 'pending';
            
            try {
                console.log(`üîÑ Updating status for order ${orderId}, guest ${guest}, item ${itemIndex}: ${currentStatus} ‚Üí ${newStatus}`);
                
                const response = await fetch(`${API_BASE}/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        guest: guest,
                        itemIndex: itemIndex,
                        newStatus: newStatus
                    })
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    // If JSON parsing fails, check if status is successful
                    if (response.ok) {
                        result = { success: true };
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${result.error || response.statusText}`);
                }
                
                console.log('‚úÖ Status updated successfully:', result);
                
                // Refresh group details
                await selectGroup(orderId);
                
            } catch (error) {
                console.error('‚ùå Failed to update status:', error);
                alert(`Erreur lors de la mise √† jour du statut: ${error.message}`);
            }
        }
        
        // üé® Helper functions
        function getStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'served': 
                case 'servi': return 'status-servi';
                case 'pending':
                case 'non servi': return 'status-non-servi';
                default: return 'status-non-servi';
            }
        }
        
        function updateConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `connection-status ${type}`;
            statusDiv.textContent = message;
        }
        
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(view + '-view').classList.add('active');
            event.target.classList.add('active');
            
            if (view === 'host') {
                showGroupsView();
                loadGroups();
            }
        }
        
        function showGroupsView() {
            document.getElementById('groupsView').style.display = 'block';
            document.getElementById('groupDetailsView').style.display = 'none';
        }
        
        function showGroupDetailsView() {
            document.getElementById('groupsView').style.display = 'none';
            document.getElementById('groupDetailsView').style.display = 'block';
        }
        
        function isHostView() {
            return document.getElementById('host-view').classList.contains('active');
        }
    </script>
</body>
</html>